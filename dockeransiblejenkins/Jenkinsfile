def getVersion(){
    def commitHash = sh label: '', returnStdout: true, script: 'git rev-parse --short HEAD'
    return commitHash
}

environment {
   imagename = "kammana/hariapp:${DOCKER_TAG}"
   DOCKER_TAG = getVersion()
}

node{
    stage('SCM Checkout'){
        git 'https://github.com/mmadsen340/udemy_jenkins_ansible.git'
    }

    stage('Download Approved war file'){
            withAWS(region:'us-east-1',credentials:'artifact_repository') 
            {
                s3Download(bucket: 'artifact-repository-807271945287', file: 'target/', force: true, path: 'dockeransible/')
            }
        }

    stage('Docker Build'){
      steps{
         sh "docker build dockeransiblejenkins/ -t kammana/hariapp:${DOCKER_TAG}"
        }
      }

  }